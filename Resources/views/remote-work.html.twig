{% extends 'page_setup.html.twig' %}
{% import "macros/widgets.html.twig" as widgets %}

{% block main %}

    {# Statistics card #}
    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">{{ 'remote_work.statistics'|trans }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="bg-primary text-white avatar me-3">{{ icon('fas fa-home') }}</span>
                        <div>
                            <div class="text-muted">{{ 'remote_work.homeoffice_days'|trans }}</div>
                            <div class="h3 mb-0">{{ stats.homeOfficeDays }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="bg-orange text-white avatar me-3">{{ icon('fas fa-car') }}</span>
                        <div>
                            <div class="text-muted">{{ 'remote_work.business_trip_days'|trans }}</div>
                            <div class="h3 mb-0">{{ stats.businessTripDays }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="bg-green text-white avatar me-3">{{ icon('fas fa-calendar-check') }}</span>
                        <div>
                            <div class="text-muted">{{ 'remote_work.total_days'|trans }}</div>
                            <div class="h3 mb-0">{{ stats.totalDays }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Type cards #}
    <div class="row row-cards mb-3">
        {% set active = is_granted('create_own_remote_work') or is_granted('edit_other_remote_work') %}
        {% for type in types %}
            <div class="col-lg-6">
                <div class="card card-md">
                    <div class="card-stamp card-stamp-lg">
                        <div class="card-stamp-icon bg-primary" style="background-color: {{ type.color }}!important">
                            {{ icon(type.icon) }}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-10">
                                <h3 class="h1">{{ type.title|trans }}</h3>
                                <div class="markdown text-muted">
                                    {% if type.type == 'homeoffice' %}
                                        {{ type.intro|trans({'%days%': stats.homeOfficeDays}) }}
                                    {% else %}
                                        {{ type.intro|trans({'%days%': stats.businessTripDays}) }}
                                    {% endif %}
                                </div>
                                <div class="mt-3">
                                    {% if active %}
                                        <a href="{{ path('remote_work_create', {'type': type.type, 'profile': user.id, 'date': create_date}) }}" class="btn btn-primary modal-ajax-form">{{ type.button|trans }}</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {# Data tables by month #}
    {% for monthKey, settings in dataTables|filter(settings => settings.table.hasResults()) %}
        <h2 class="mt-3">{{ create_date(monthKey ~ '-01')|month_name(true) }}</h2>
        {% set dataTable = settings.table %}
        {% embed 'embeds/datatable.html.twig' %}
            {% from "macros/widgets.html.twig" import table_actions, label_color %}
            {% import "macros/datatables.html.twig" as tables %}
            {% block datatable_row_attr %}{% if is_granted('edit_own_remote_work') or is_granted('edit_other_remote_work') %} class="modal-ajax-form open-edit" data-href="{{ path('remote_work_edit', {'id': entry.id}) }}" {% endif %}{% endblock %}
            {% block datatable_column_value %}
                {% if column == 'date' %}
                    {{ entry.date|date_short }}
                {% elseif column == 'type' %}
                    {% set color = entry.homeoffice ? '#4dabf7' : '#f76707' %}
                    {% set typeName = entry.homeoffice ? 'homeoffice' : 'business_trip' %}
                    {{ label_color(typeName|trans, color) }}
                {% elseif column == 'time' %}
                    {% if entry.halfDay %}
                        {{ 'day_half'|trans }}
                    {% else %}
                        {{ 'day_full'|trans }}
                    {% endif %}
                {% elseif column == 'status' %}
                    {% if entry.approved %}
                        {{ label_color('status.approved'|trans, '#2fb344') }}
                    {% elseif entry.rejected %}
                        {{ label_color('status.rejected'|trans, '#d63939') }}
                    {% else %}
                        {{ label_color('status.new'|trans, '#4299e1') }}
                    {% endif %}
                {% elseif column == 'user' %}
                    {{ entry.user.displayName }}
                {% elseif column == 'comment' %}
                    {{ entry.comment }}
                {% elseif column == 'actions' %}
                    {% set event = actions(app.user, 'remote_work', 'index', {'remote_work': entry}) %}
                    {{ table_actions(event.actions) }}
                {% elseif column == 'id' %}
                    {% if dataTable.hasBatchForm() %}
                        <input type="checkbox" name="id" value="{{ entry.id }}" class="multi_update_single multiupdater form-check-input m-0 align-middle" title="{{ 'batch_table_checkbox'|trans }}"{% if entry.new %} checked{% endif %}>
                    {% endif %}
                {% else %}
                    {{ column }}
                {% endif %}
            {% endblock %}
        {% endembed %}
    {% endfor %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if approval_required %}
    <script>
        document.addEventListener('kimai.initialized', function(event) {
            // Trigger form display for tables with pre-selected entries
            {% for monthKey, settings in dataTables|filter(settings => settings.hasNew) %}
            const table{{ loop.index }} = document.querySelector('#multi_update_all_remote_work_{{ monthKey }}')?.closest('table');
            if (table{{ loop.index }}) {
                const card = table{{ loop.index }}.closest('div.card.data_table');
                let ids = [];
                for (const box of table{{ loop.index }}.querySelectorAll('input.multi_update_single:checked')) {
                    ids.push(box.value);
                }
                if (ids.length > 0) {
                    card.querySelector('.multi_update_ids').value = ids.join(',');
                    for (const element of card.querySelectorAll('.multi_update_form_hide')) {
                        element.style.setProperty('display', 'none', 'important');
                    }
                    card.querySelector('form.multi_update_form').style.display = null;
                }
            }
            {% endfor %}
        });
    </script>
    {% endif %}
{% endblock %}
